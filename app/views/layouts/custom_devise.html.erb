<!DOCTYPE html>
<html>
<head>
  <title>BFR Webapp</title>
  <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.5.1/build/cssreset/cssreset-min.css">
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
  <link rel="shortcut icon" href="/favicon.ico" type="image/ico" />
  <%= stylesheet_link_tag "common", "devise", :media => "all" %>
  <%= javascript_include_tag "application" %>
  <%= csrf_meta_tags %>
</head>
<%
#Code for ruby that should be moved into a controller

list_of_all_pickups = []
total_number_pickups = 0
pickups_this_day = 0
pickups_this_week = 0
pickups_this_month = 0
pickups_this_year = 0

total_amount_of_food = 0
food_lbs_last_12_months = []
month_labels = ''

number_of_volunteers = 0

recipient_count = 0

list_of_donors = []
donor_count = 0

#Get the pickup stats
total_number_pickups = Log.count
time = Time.new
date = Date.new(time.year, time.month, time.day)
pickups_this_day = Log.count(:conditions => {:when => date})
pickups_this_week = Log.count(:conditions => {:when => date.at_beginning_of_week(start_day = :sunday)...date.at_end_of_week(start_day = :sunday)})
pickups_this_month = Log.count(:conditions => {:when => date.at_beginning_of_month()...date.at_end_of_month()})
pickups_this_year = Log.count(:conditions => {:when => date.at_beginning_of_year()...date.at_end_of_year()})
  
#Amount of food stats
current_month = time.month
current_year = time.year
months = []
for i in 0..11
  start_year = current_year
  start_month = current_month - i
  if start_month < 1
    start_month += 12
    start_year += -1
  elsif start_month > 12
    start_month -= 12
	start_year += 1
  end
  end_year = start_year
  end_month = start_month + 1
  if end_month < 1
    end_month += 12 
	end_year += -1
  elsif end_month > 12
	end_month -= 12 
	end_year += 1
  end
  m_start = Date.new(start_year, start_month)
  m_end = Date.new(end_year, end_month)
  months << [m_start, m_end]
  month_labels += m_start.strftime('%B')[0...3] +'|'
end
months.each do |query|
  weight = Log.where(:when => query[0]...query[1]).where("weight IS NOT NULL").sum(:weight)
  food_lbs_last_12_months << weight
end
total_amount_of_food = Log.where("logs.weight IS NOT NULL").sum(:weight)


#Volunteer info
number_of_volunteers = Volunteer.count()
  
#Recipient Stats
recipient_count = Location.count(:conditions => {:is_donor => false})
  
#Donor Stats
list_of_donors = Location.where(:is_donor => true)
donor_count = list_of_donors.length

#Transportation Stats
total_trips = Log.count()
bike_trips = Log.count(:conditions => { :transport => 'Bike' })
car_trips = Log.count(:conditions => { :transport => 'Car' })
walking_trips = Log.count(:conditions => { :transport => 'Foot' })
nil_values = Log.count(:conditions => { :transport => nil })
other_trips = total_trips - walking_trips - car_trips - bike_trips - nil_values
human_power_percent = (((bike_trips + walking_trips).to_f / (total_trips - nil_values))*100).to_i

#Transporation Pie Chart


%>
<body>
  <div class="container">
	  <div class="header">
		<div>
		  <h2 id="bfr_title">Boulder Food Rescue</h2>
		  <h3>Sustainable Just-In-Time Food Rescue in Boulder, Colorado</h3>
		</div>  
		<%= link_to image_tag("logo.png", :class => 'logo_image')%>
	  </div>
	  <div class="wrap">
		<div class="info_section">
		  <h2 class="section_title"> About BFR </h2>
		  <p>
			Boulder Food Rescue is an all volunteer non-profit organization located in Boulder, CO. 
			We rescue and redistribute perishable food "waste" to charities that serve homeless and 
			at-risk individuals. Our goal is to help solve the problems of hunger, malnutrition, and 
			food waste in our community.
		  </p>
		  <div>
			<p>Read more at <a href="http://www.boulderfoodrescue.org">www.boulderfoodrescue.org</a></p>
		  </div>
		  <h2 class="section_title">Facts</h2>
		  <div class="fact_section">
			<div class="a_fact_section">
			  <p>Total Food Pickups To Date: <%= total_number_pickups %> pickups</p>
			  <p class="show_pickups_to_date text_link"> chart </p>
			  <div class="fact_info">
				<div><p> Pickups today :  <%= pickups_this_day %></p></div>
				<div><p> Pickups this week : <%= pickups_this_week %></p></div>
				<div><p> Pickups this month: <%= pickups_this_month %></p></div>
				<div><p> Pickups this year: <%= pickups_this_year %></p></div>
			  </div>
			</div>
			<div class="a_fact_section">
			  <p>Total Food Rescued: 
				<%= total_amount_of_food.to_i %>
			  lbs
			  </p>
			  <p class="food_pickup text_link"> chart </p>
			  <div class="fact_info">
				<img src="<%= Gchart.bar(:size => '493x300', 
				  :title => "Food Collected By Month",
				  :bg => 'e4e4e4',
				  :data => food_lbs_last_12_months,
				  :bar_width_and_spacing => '25,14',
				  :axis_with_labels => 'x,y',
				  :axis_labels => [month_labels, ''],
				  :axis_range => [nil, [0,food_lbs_last_12_months.max,250]]) %>"
				  alt="pickup chart"/>
			  </div>
			</div>
			<div class="a_fact_section">  
			  <p>Number of Volunteers: <%= number_of_volunteers %> volunteers</p>
			  <p class="volunteer_facts text_link"> fun facts </p>
			  <div class="fact_info">
				<div><p> Fact about our Volunteers </p></div>
				<div><p> Fact about our Volunteers </p></div>
				<div><p> Fact about our Volunteers </p></div>
				<div><p> Fact about our Volunteers </p></div>
				<div><p> Fact about our Volunteers </p></div>
			  </div>
			</div>
			<div class="a_fact_section">
			  <p>Number of Recipients: <%= recipient_count %></p>
			  <p class="show_recipient_facts text_link"> fun facts </p>
			  <div class="fact_info">
				<div><p>
				  See a list of some of our recipients at 
				  <a href="http://www.boulderfoodrescue.org/index.php/recipients/"> Recipient List </a>
				</p></div>
			  </div>
			</div>
			<div class="a_fact_section">  
			  <p>Number of Donors: <%= donor_count %></p>
			  <p class="show_donor_list text_link">list</p>
			  <div class="fact_info donor_list">
				<% donors = Location.where(:is_donor => true) %>
				<% donors.each do |donor| %>
				<div> <p class="donor_name"> <%= donor.name %> </p> </div>
				<% end %>
			  </div>
			</div>  
			<div class="a_fact_section">
			  <p>Percent of trips human powered: 
				<%= human_power_percent %> %
			  </p>
			  <p class="show_trans_chart text_link"> chart </p>
			  <div class="fact_info transportation_chart">
				<img src="
				<%= 
				Gchart.pie( :data => [bike_trips, car_trips, walking_trips, other_trips], 
							:title => 'Transportation Type', 
							:size => '493x200', 
							:labels => ['Bike', 'Car', 'Foot', 'Other'],
							:bg => 'e4e4e4') 
				%>
				" alt="Google Chart"/>
			  </div>
			</div>
		  </div>
		</div>
		<div class="sign_in_section">
		  <div>
			<%= yield %>
		  </div>
		</div>
	  </div>
	  <div class="push"></div>
	  <div class="footer">
		<p>Copyright Â© <a href="http:www.boulderfoodrescue.org">Boulder Food Rescue</a> 2012</p>
	  </div>
  </div>
</body>
</html>